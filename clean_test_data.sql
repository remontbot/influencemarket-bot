-- ============================================================
-- ОЧИСТКА ТЕСТОВЫХ ДАННЫХ ИЗ СТАРОГО БОТА ПО СТРОЙКЕ
-- ============================================================
--
-- Этот SQL-скрипт удаляет все тестовые данные:
-- • Кампании со старыми категориями (Электрика, Сантехника и т.д.)
-- • Тестовых блогеров (Telegram ID 100000000-100000999)
-- • Тестового рекламодателя
-- • Все связанные данные (отклики, сообщения, категории)
--
-- ВНИМАНИЕ: Операция необратима! Сделайте бэкап перед выполнением.
-- ============================================================

-- Начинаем транзакцию
BEGIN;

-- ============================================================
-- ШАГ 1: Проверяем, сколько тестовых данных будет удалено
-- ============================================================

-- Подсчет тестовых кампаний
SELECT
    'Тестовых кампаний найдено:' AS info,
    COUNT(*) AS count
FROM campaigns
WHERE category IN (
    'Электрика', 'Сантехника', 'Отделка', 'Сборка мебели',
    'Окна/двери', 'Бытовая техника', 'Напольные покрытия',
    'Мелкий ремонт', 'Дизайн'
);

-- Подсчет тестовых блогеров
SELECT
    'Тестовых блогеров найдено:' AS info,
    COUNT(*) AS count
FROM bloggers
WHERE user_id >= 100000000 AND user_id <= 100000999;

-- Подсчет тестовых рекламодателей
SELECT
    'Тестовых рекламодателей найдено:' AS info,
    COUNT(*) AS count
FROM advertisers
WHERE name = 'Тестовый клиент';

-- ============================================================
-- ШАГ 2: Удаление тестовых кампаний и связанных данных
-- ============================================================

-- Удаляем сообщения из чата для тестовых кампаний
DELETE FROM messages
WHERE campaign_id IN (
    SELECT id FROM campaigns
    WHERE category IN (
        'Электрика', 'Сантехника', 'Отделка', 'Сборка мебели',
        'Окна/двери', 'Бытовая техника', 'Напольные покрытия',
        'Мелкий ремонт', 'Дизайн'
    )
);

-- Удаляем отказы от тестовых кампаний
DELETE FROM declined_campaigns
WHERE campaign_id IN (
    SELECT id FROM campaigns
    WHERE category IN (
        'Электрика', 'Сантехника', 'Отделка', 'Сборка мебели',
        'Окна/двери', 'Бытовая техника', 'Напольные покрытия',
        'Мелкий ремонт', 'Дизайн'
    )
);

-- Удаляем отклики на тестовые кампании
DELETE FROM offers
WHERE campaign_id IN (
    SELECT id FROM campaigns
    WHERE category IN (
        'Электрика', 'Сантехника', 'Отделка', 'Сборка мебели',
        'Окна/двери', 'Бытовая техника', 'Напольные покрытия',
        'Мелкий ремонт', 'Дизайн'
    )
);

-- Удаляем категории тестовых кампаний
DELETE FROM campaign_categories
WHERE campaign_id IN (
    SELECT id FROM campaigns
    WHERE category IN (
        'Электрика', 'Сантехника', 'Отделка', 'Сборка мебели',
        'Окна/двери', 'Бытовая техника', 'Напольные покрытия',
        'Мелкий ремонт', 'Дизайн'
    )
);

-- Удаляем сами тестовые кампании
DELETE FROM campaigns
WHERE category IN (
    'Электрика', 'Сантехника', 'Отделка', 'Сборка мебели',
    'Окна/двери', 'Бытовая техника', 'Напольные покрытия',
    'Мелкий ремонт', 'Дизайн'
);

-- ============================================================
-- ШАГ 3: Удаление тестовых блогеров и их данных
-- ============================================================

-- Удаляем категории тестовых блогеров
DELETE FROM blogger_categories
WHERE blogger_id IN (
    SELECT id FROM bloggers
    WHERE user_id >= 100000000 AND user_id <= 100000999
);

-- Удаляем города тестовых блогеров
DELETE FROM blogger_cities
WHERE blogger_id IN (
    SELECT id FROM bloggers
    WHERE user_id >= 100000000 AND user_id <= 100000999
);

-- Удаляем отклики тестовых блогеров
DELETE FROM offers
WHERE blogger_id IN (
    SELECT id FROM bloggers
    WHERE user_id >= 100000000 AND user_id <= 100000999
);

-- Удаляем настройки уведомлений тестовых блогеров
DELETE FROM blogger_notifications
WHERE blogger_id IN (
    SELECT id FROM bloggers
    WHERE user_id >= 100000000 AND user_id <= 100000999
);

-- Удаляем самих тестовых блогеров
DELETE FROM bloggers
WHERE user_id >= 100000000 AND user_id <= 100000999;

-- ============================================================
-- ШАГ 4: Удаление тестового рекламодателя
-- ============================================================

-- Удаляем тестового рекламодателя (только если у него нет кампаний)
DELETE FROM advertisers
WHERE name = 'Тестовый клиент'
AND id NOT IN (SELECT DISTINCT advertiser_id FROM campaigns);

-- ============================================================
-- ШАГ 5: Проверяем результаты после очистки
-- ============================================================

SELECT
    'Всего кампаний после очистки:' AS info,
    COUNT(*) AS count
FROM campaigns;

SELECT
    'Открытых кампаний после очистки:' AS info,
    COUNT(*) AS count
FROM campaigns
WHERE status = 'open';

SELECT
    'Всего блогеров после очистки:' AS info,
    COUNT(*) AS count
FROM bloggers;

SELECT
    'Всего рекламодателей после очистки:' AS info,
    COUNT(*) AS count
FROM advertisers;

SELECT
    'Всего откликов после очистки:' AS info,
    COUNT(*) AS count
FROM offers;

-- Если все выглядит правильно, выполните COMMIT
-- Если что-то не так, выполните ROLLBACK

-- COMMIT;
-- ROLLBACK;
